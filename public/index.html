<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="styles.css" />
    <title>Control OSC</title>
    <!-- <script src="https://cdn.jsdelivr.net/npm/handtrackjs@0.0.24"></script> -->
  </head>
  <body>
    <section>
      <button onclick="sendOscMessage()">Enviar texto OSC</button>
      <button onclick="sequenceOne()">play secuencia 1</button>
      <button onclick="sequenceTwo()">play secuencia 2</button>
    </section>
    <section class="slider-group">
      <label for="red">Rojo:</label>
      <input
        type="range"
        id="red"
        name="red"
        min="0"
        max="1"
        step="0.001"
        value="0"
      />

      <label for="green">Verde:</label>
      <input
        type="range"
        id="green"
        name="green"
        min="0"
        max="1"
        step="0.001"
        value="0"
      />

      <label for="blue">Azul:</label>
      <input
        type="range"
        id="blue"
        name="blue"
        min="0"
        max="1"
        step="0.001"
        value="0"
      />

      <h1>
        <label for="blue" style="font-size: 32px">OSC Frecuency:</label>
      </h1>
      <input
        type="range"
        id="frecuency"
        name="frecuency"
        min="0"
        max="1"
        step="0.001"
        value="0"
      />
    </section>

    <section>
      <label for="vol">lineWidth:</label>
      <input
        type="range"
        id="vol"
        name="vol"
        min="0"
        max="1"
        step="0.001"
        value="0"
      />
      <video
        id="webcam"
        width="250"
        height="200"
        autoplay
        muted
        style="display: none"
      ></video>
      <canvas id="canvas" width="250" height="200"></canvas>
    </section>

    <script src="./main.js"></script>

    <script>
      const socket = new WebSocket("ws://192.168.68.108:8080");

      function sendOscWithValue(val) {
        const oscMessage = {
          address: "/medias/Line_Patterns/Global/Line_Width",
          args: [val],
        };
        // Utilizamos el socket ya creado
        if (socket.readyState === WebSocket.OPEN) {
          socket.send(JSON.stringify(oscMessage));
        }
      }

      function sendOscRedValue(val) {
        const oscMessage = {
          address: "/fixtures/Group-1/color/red",
          args: [val],
        };
        // Utilizamos el socket ya creado
        if (socket.readyState === WebSocket.OPEN) {
          socket.send(JSON.stringify(oscMessage));
        }
      }

      function sendOscGreenValue(val) {
        const oscMessage = {
          address: "/fixtures/Group-1/color/green",
          args: [val],
        };
        // Utilizamos el socket ya creado
        if (socket.readyState === WebSocket.OPEN) {
          socket.send(JSON.stringify(oscMessage));
        }
      }

      function sendOscBlueValue(val) {
        const oscMessage = {
          address: "/fixtures/Group-1/color/blue",
          args: [val],
        };
        // Utilizamos el socket ya creado
        if (socket.readyState === WebSocket.OPEN) {
          socket.send(JSON.stringify(oscMessage));
        }
      }
      function sendOscFrecuencyValue(val) {
        const numValue = parseFloat(val);
        const oscMessage = {
          address: "/abletonWww",
          args: [numValue],
        };
        // Utilizamos el socket ya creado
        if (socket.readyState === WebSocket.OPEN) {
          socket.send(JSON.stringify(oscMessage));
        }
      }

      window.addEventListener("beforeunload", function () {
        socket.close();
      });

      document.getElementById("vol").addEventListener("input", function () {
        const val = this.value * 2;
        sendOscWithValue(val);
      });
      document.getElementById("red").addEventListener("input", function () {
        const val = this.value;
        sendOscRedValue(val);
      });
      document.getElementById("green").addEventListener("input", function () {
        const val = this.value;
        sendOscGreenValue(val);
      });
      document.getElementById("blue").addEventListener("input", function () {
        const val = this.value;
        sendOscBlueValue(val);
      });
      document
        .getElementById("frecuency")
        .addEventListener("input", function () {
          const val = this.value;
          sendOscFrecuencyValue(val);
        });

      // web socket initialization
      socket.onopen = function (event) {
        console.log("Conectado al servidor WebSocket");
      };

      socket.onerror = function (error) {
        console.error("Error en la conexión WebSocket:", error);
      };

      socket.onclose = function (event) {
        if (event.wasClean) {
          console.log(
            `[CERRADO] Conexión cerrada limpiamente, código=${event.code}, razón=${event.reason}`
          );
        } else {
          // Ejemplo: el servidor cierra la conexión abruptamente
          console.error("[CERRADO] Conexión muerta");
        }
      };

      function triggerInputEvent(element) {
        const event = new Event("input", {
          bubbles: true,
          cancelable: true,
        });
        element.dispatchEvent(event);
      }

      socket.onmessage = function (event) {
        const oscData = JSON.parse(event.data);
        if (oscData.address === "/abletonWeb") {
          const slider = document.getElementById("frecuency");
          slider.value = oscData.value;
          triggerInputEvent(slider);
        }
      };

      function moveSlider(val) {
        const oscMessage = {
          address: "/medias/Line_Patterns/Global/Line_Width",
          args: [1.0, "someString", "hola mndo"],
        };
        socket.send(JSON.stringify(oscMessage));
      }

      function sendOscMessage() {
        const oscMessage = {
          address: "/medias/Text_Generator/Font/Text/Note1",
          args: [1.0, "someString", "hola mndo"],
        };
        socket.send(JSON.stringify(oscMessage));
      }
      function sequenceOne() {
        const oscMessage = {
          address: "/cues/selected/scenes/by_cell/col_1/scene1",
          args: [1.0, "someString", "hola mndo"],
        };
        socket.send(JSON.stringify(oscMessage));
      }
      function sequenceTwo() {
        const oscMessage = {
          address: "/cues/selected/scenes/by_cell/scene2",
          args: [1.0, "someString", "hola mndo"],
        };
        socket.send(JSON.stringify(oscMessage));
      }
    </script>
  </body>
</html>
